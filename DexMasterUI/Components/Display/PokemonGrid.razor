@using System.Collections.ObjectModel

<MudOverlay @bind-Visible="_isLoading" DarkBackground="true" ZIndex="9999">
    <MudProgressCircular Color="Color.Secondary" Indeterminate="true" />
</MudOverlay>

<MudStack>
    @if(_pokemons == null)
    {
        <MudText>Loading Pokemon...</MudText>
    }
    else if (_pokemons.Any())
    {
        <MudGrid>
            @foreach (Pokemon pokemon in _pokemons)
            {
                <MudItem lg="2" md="6" xs="12">
                    <CascadingValue Value="@_loggedInUser">
                        <PokemonCard Pokemon="@pokemon" />
                    </CascadingValue>
                </MudItem>
            }
        </MudGrid>
    }
    else
    {
        <MudText>No Pokemon were found</MudText>
    }
    <MudPaper>
        <MudGrid Class="d-flex align-center mud-width-full py-3">
            <MudItem lg="1" xs="2"></MudItem>
            <MudItem lg="1" xs="2"></MudItem>
            <MudItem lg="8" xs="6">
                <MudPagination Selected="_currentPage"
                               Count="10"
                               SelectedChanged="OnPageChanged"
                               ShowFirstButton="true"
                               ShowLastButton="true"
                               BoundaryCount="2" MiddleCount="3"
                               Class="justify-center mud-width-full" />
            </MudItem>
            <MudItem lg="1" xs="2">
                <MudNumericField Margin="Margin.Dense" @bind-Value="_currentPage" Min="1" Max="10" Variant="Variant.Outlined" Label="Page" />
            </MudItem>
            <MudItem lg="1" xs="2">
                <MudSelect T="int"
                @bind-Value="_defaultLimit"
                           Variant="Variant.Outlined"
                           SelectedValuesChanged="@(()=>OnPageChanged(_currentPage))"
                           Margin="Margin.Dense"
                           Label="# Per Page">
                    <MudSelectItem Value="9" />
                    <MudSelectItem Value="12" />
                    <MudSelectItem Value="15" />
                    <MudSelectItem Value="30" />
                    <MudSelectItem Value="60" />
                    <MudSelectItem Value="90" />
                </MudSelect>
            </MudItem>
        </MudGrid>
    </MudPaper>
</MudStack>

@code {
    [Parameter]
    public string UserId { get; set; }

    private const string BrowserVariableName = "CardsPerPage";

    private readonly IPokeApiService _pokeApiService = new PokeApiService();
    
    private ObservableCollection<Pokemon> _pokemons = new();
    private int _currentPage = 1;
    private int _defaultLimit = 12;
    private User _loggedInUser = null;
    private bool _isLoading = true;

    protected override async Task OnParametersSetAsync()
    {
        _isLoading = true;
        
        await CheckBrowserStorageAsync();
        
        if (_loggedInUser is null)
        {
            _loggedInUser = await authProvider.GetUserFromAuthAsync(userData);
        }

        await InitializePokemonsAsync();

        _isLoading = false;

        StateHasChanged();
    }

    private async Task OnPageChanged(int newPage)
    {
        _isLoading = true;
        _currentPage = newPage;
        
        //_pokemonData = await _pokeApiService.GetPokemonListAsync(_defaultLimit, (_currentPage-1) * _defaultLimit);

        await protectedLocalStorage.SetAsync(BrowserVariableName, _defaultLimit);

        _isLoading = false;

        StateHasChanged();
    }

    private async Task CheckBrowserStorageAsync()
    {
        var localBrowserCardsPerPageResult = await protectedLocalStorage.GetAsync<int>(BrowserVariableName);

        if (localBrowserCardsPerPageResult.Success)
        {
            _defaultLimit = localBrowserCardsPerPageResult.Value;
        }
        else
        {
            _defaultLimit = 12;
        }
    }
    
    public async Task InitializePokemonsAsync()
    {
        if (_pokemons.Any())
            return;

        try
        {
            _isLoading = true;

            await PullPokemons(_defaultLimit);
        }
        catch (Exception)
        {
            Console.WriteLine("Error getting Pokemon list");
        }
        finally
        {
            _isLoading = false;
        }
    }
    
    private async Task PullPokemons(int limit, bool clearPokemonsList = false)
    {
        if (clearPokemonsList && _pokemons.Any())
        {
            _pokemons.Clear();
        }

        var offset = _pokemons.Count();

        var pokemon = await pokeApiService.GetPokemonListAsync(limit, offset);

        pokemon.ToList().ForEach(p => _pokemons.Add(p));
    }
}