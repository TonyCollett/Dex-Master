<MudStack Row="true">
    <MudSelect T="string"
               Value="_selectedGeneration"
               ValueChanged="GenerationChanged"
               Label="Generation"
               Variant="Variant.Filled"
               AnchorOrigin="Origin.BottomCenter"
               Disabled="_generationDisabled"
               FullWidth="true">
        <MudSelectItem Value="@("national")">National</MudSelectItem>
        @if (_generations != null && _generations.Any())
        {
            @foreach (var generation in _generations)
            {
                <MudSelectItem Value="@(generation.Name)">@CommonFunctions.CleanAndCapitalise(generation.Name)</MudSelectItem>
            }
        }
    </MudSelect>
    <MudSelect T="string" 
               Value="_selectedVersion" 
               ValueChanged="VersionChanged" 
               Label="Version" 
               Variant="Variant.Filled" 
               AnchorOrigin="Origin.BottomCenter"
               Disabled="_versionDisabled"
               FullWidth="true">
        @if (_versionsInGeneration != null && _versionsInGeneration.Any())
        {
            @foreach (var version in _versionsInGeneration)
            {
                <MudSelectItem Value="@(version.Name)">@CommonFunctions.CleanAndCapitalise(version.Name)</MudSelectItem>
            }
        }
    </MudSelect>
</MudStack>

@code {
    [Parameter]
    public EventCallback<string> SelectedVersionChanged { get; set; }

    private IEnumerable<Generation> _generations;
    private List<PokeApiNet.Version> _versionsInGeneration = new();
    private PokeApiNet.Version _version;
    private bool _generationDisabled = true;
    private bool _versionDisabled = true;
    private string _selectedGeneration = "national";
    private string _selectedVersion = "";

    protected override async Task OnInitializedAsync()
    {
        _generationDisabled = _versionDisabled = true;
        _generations = await pokeApiService.GetGenerationListAsync();
        _generationDisabled = _versionDisabled = false;
    }
    
    private async Task GenerationChanged(string value)
    {
        _versionDisabled = true;

        if (string.IsNullOrWhiteSpace(value) == false)
        {
            if (value == "national")
            {
                _selectedGeneration = "National";
                _selectedVersion = "";
                _versionDisabled = true;
                _versionsInGeneration.Clear();
            }
            else
            {
                Generation generation = await pokeApiService.GetGenerationByNameAsync(value);
                _selectedGeneration = generation.Name;
                _selectedVersion = "";
                _versionsInGeneration.Clear();
                
                foreach (var versionGroup in generation.VersionGroups)
                {
                    var versionGroupObject = await pokeApiService.GetVersionGroupByNameAsync(versionGroup.Name);
                    
                    foreach (var version in versionGroupObject.Versions)
                    {
                        var versionObject = await pokeApiService.GetVersionByNameAsync(version.Name);
                        _versionsInGeneration.Add(versionObject);
                    }
                }
            }
        }
        
        _versionDisabled = false;
        StateHasChanged();
    }
    
    private async Task VersionChanged(string value)
    {
        _version = await pokeApiService.GetVersionByNameAsync(value);
        _selectedVersion = _version.Name;
        await SelectedVersionChanged.InvokeAsync(_selectedVersion);
        StateHasChanged();
    }
}